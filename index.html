<!DOCTYPE html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <title>Lissajous Lab</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --bg-0: #08080c;
        --bg-1: #0f0f15;
        --bg-2: #16161f;
        --bg-3: #1e1e2a;
        --bg-4: #282836;
        --text-0: #ffffff;
        --text-1: #b8b8c8;
        --text-2: #6e6e82;
        --accent: #6366f1;
        --accent-rgb: 99, 102, 241;
        --accent-soft: rgba(99, 102, 241, 0.15);
        --accent-hover: #818cf8;
        --border: #2a2a3a;
        --success: #22c55e;
        --shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        --accent-base-l: 65%;
        --accent-base-s: 70%;
        --safe-area-bottom: env(safe-area-inset-bottom, 0px);
      }

      [data-theme="light"] {
        --bg-0: #ffffff;
        --bg-1: #f8f9fc;
        --bg-2: #f0f1f5;
        --bg-3: #e8e9f0;
        --bg-4: #dcdde5;
        --text-0: #0f0f15;
        --text-1: #4a4a5a;
        --text-2: #8888a0;
        --border: #d8d9e2;
        --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        --accent-base-l: 45%;
        --accent-base-s: 60%;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui,
          sans-serif;
        background: var(--bg-0);
        color: var(--text-0);
        height: 100vh;
        height: 100dvh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        -webkit-tap-highlight-color: transparent;
      }

      button,
      .toggle {
        touch-action: manipulation;
      }

      header {
        background: var(--bg-1);
        border-bottom: 1px solid var(--border);
        padding: 0.5rem 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        height: 48px;
        flex-shrink: 0;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1rem;
        font-weight: 700;
      }

      .logo svg {
        width: 24px;
        height: 24px;
      }

      .header-actions {
        display: flex;
        gap: 0.25rem;
        align-items: center;
      }

      .icon-btn {
        width: 32px;
        height: 32px;
        border: none;
        background: transparent;
        color: var(--text-1);
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
      }

      .icon-btn:hover {
        background: var(--bg-3);
        color: var(--text-0);
      }

      .icon-btn.accent {
        color: var(--accent);
      }

      .divider {
        width: 1px;
        height: 20px;
        background: var(--border);
        margin: 0 0.25rem;
      }

      .main {
        display: flex;
        flex: 1;
        overflow: hidden;
      }

      .sidebar {
        width: 280px;
        background: var(--bg-1);
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
      }

      .tabs {
        display: flex;
        border-bottom: 1px solid var(--border);
        background: var(--bg-2);
      }

      .tab {
        flex: 1;
        padding: 0.625rem 0.5rem;
        border: none;
        background: transparent;
        color: var(--text-2);
        font-size: 0.6875rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.03em;
        cursor: pointer;
        transition: all 0.15s;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
      }

      .tab svg {
        width: 16px;
        height: 16px;
        opacity: 0.6;
      }

      .tab:hover {
        color: var(--text-1);
        background: var(--bg-3);
      }

      .tab.active {
        color: var(--accent);
        background: var(--bg-1);
        box-shadow: inset 0 -2px 0 var(--accent);
      }

      .tab.active svg {
        opacity: 1;
      }

      .tab-content {
        flex: 1;
        overflow-y: auto;
        padding: 0.75rem;
      }

      .tab-content::-webkit-scrollbar {
        width: 4px;
      }

      .tab-content::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 2px;
      }

      .sidebar-footer {
        margin-top: auto;
        padding: 0.75rem 1rem;
        border-top: 1px solid var(--border);
        font-size: 0.6875rem;
        color: var(--text-2);
      }

      .sidebar-footer a {
        color: var(--text-1);
        text-decoration: none;
      }

      .sidebar-footer a:hover {
        color: var(--accent);
      }

      .tab-panel {
        display: none;
      }

      .tab-panel.active {
        display: block;
      }

      .group {
        margin-bottom: 0.75rem;
      }

      .group-title {
        font-size: 0.625rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-2);
        margin-bottom: 0.5rem;
        padding: 0 0.25rem;
      }

      .group-content {
        background: var(--bg-2);
        border-radius: 8px;
        padding: 0.5rem;
      }

      .row {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
      }

      .row:last-child {
        margin-bottom: 0;
      }

      .field {
        flex: 1;
        min-width: 0;
      }

      .field-label {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.6875rem;
        color: var(--text-2);
        margin-bottom: 0.25rem;
      }

      .field-value {
        font-family: "SF Mono", Monaco, "Consolas", monospace;
        font-size: 0.625rem;
        color: var(--accent);
        background: var(--bg-3);
        padding: 0.125rem 0.375rem;
        border-radius: 3px;
      }

      input[type="range"] {
        width: 100%;
        height: 4px;
        background: var(--bg-4);
        border-radius: 2px;
        outline: none;
        -webkit-appearance: none;
      }

      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 12px;
        height: 12px;
        background: var(--accent);
        border-radius: 50%;
        cursor: pointer;
        transition: transform 0.1s;
      }

      input[type="range"]::-webkit-slider-thumb:hover {
        transform: scale(1.2);
      }

      input[type="number"],
      select,
      input[type="text"] {
        width: 100%;
        padding: 0.375rem 0.5rem;
        background: var(--bg-3);
        border: 1px solid transparent;
        border-radius: 6px;
        color: var(--text-0);
        font-size: 0.75rem;
        outline: none;
        transition: border-color 0.15s;
      }

      input[type="number"] {
        -moz-appearance: textfield;
      }

      input[type="number"]::-webkit-outer-spin-button,
      input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }

      input[type="number"]:focus,
      select:focus,
      input[type="text"]:focus {
        border-color: var(--accent);
      }

      input[type="color"] {
        width: 100%;
        height: 28px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        background: var(--bg-3);
        padding: 2px;
      }

      input[type="color"]::-webkit-color-swatch-wrapper {
        padding: 0;
      }

      input[type="color"]::-webkit-color-swatch {
        border: none;
        border-radius: 4px;
      }

      .toggle-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.25rem 0;
      }

      .toggle-label {
        font-size: 0.6875rem;
        color: var(--text-1);
      }

      .toggle {
        position: relative;
        width: 36px;
        height: 20px;
        background: var(--bg-4);
        border-radius: 10px;
        cursor: pointer;
        transition: background 0.2s;
      }

      .toggle.active {
        background: var(--accent);
      }

      .toggle::after {
        content: "";
        position: absolute;
        top: 2px;
        left: 2px;
        width: 16px;
        height: 16px;
        background: white;
        border-radius: 50%;
        transition: transform 0.2s;
      }

      .toggle.active::after {
        transform: translateX(16px);
      }

      .presets {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 0.375rem;
      }

      .preset {
        aspect-ratio: 1;
        background: var(--bg-3);
        border: 1px solid transparent;
        border-radius: 6px;
        cursor: pointer;
        padding: 0.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
      }

      .preset:hover {
        border-color: var(--accent);
        transform: scale(1.05);
      }

      .preset svg {
        width: 100%;
        height: 100%;
        display: block;
      }

      .canvas-area {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--bg-0);
        position: relative;
        overflow: hidden;
      }

      .canvas-bg {
        position: absolute;
        inset: 0;
        background-image: radial-gradient(
          circle at 1px 1px,
          var(--border) 1px,
          transparent 0
        );
        background-size: 20px 20px;
        opacity: 0.5;
      }

      .canvas-wrapper {
        position: relative;
        z-index: 1;
        max-width: calc(100% - 2rem);
        max-height: calc(100% - 5rem);
      }

      .canvas-frame {
        background: var(--bg-1);
        border-radius: 8px;
        padding: 12px;
        box-shadow: var(--shadow);
        display: inline-block;
      }

      #preview {
        display: block;
        border-radius: 4px;
        max-width: 100%;
        max-height: calc(100vh - 200px);
      }

      .canvas-info {
        position: absolute;
        bottom: -28px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 0.625rem;
        color: var(--text-2);
        white-space: nowrap;
      }

      .export-bar {
        position: absolute;
        bottom: 1rem;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 0.375rem;
        background: var(--bg-2);
        padding: 0.375rem;
        border-radius: 10px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
        z-index: 10;
      }

      .export-btn {
        padding: 0.5rem 0.875rem;
        border: none;
        border-radius: 6px;
        font-size: 0.6875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.15s;
        display: flex;
        align-items: center;
        gap: 0.375rem;
      }

      .export-btn.primary {
        background: var(--accent);
        color: var(--bg-0);
      }

      .export-btn.primary:hover {
        filter: brightness(1.1);
      }

      .export-btn.secondary {
        background: var(--bg-3);
        color: var(--text-1);
      }

      .export-btn.secondary:hover {
        background: var(--bg-4);
        color: var(--text-0);
      }

      .export-btn svg {
        width: 14px;
        height: 14px;
      }

      .play-btn {
        width: 100%;
        height: 32px;
        border: none;
        background: var(--accent);
        color: var(--bg-0);
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        font-size: 0.75rem;
        font-weight: 600;
        margin-top: 0.5rem;
      }

      .play-btn:hover {
        filter: brightness(1.1);
      }

      .play-btn svg {
        width: 14px;
        height: 14px;
      }

      .num-input {
        display: flex;
        align-items: center;
        background: var(--bg-3);
        border-radius: 6px;
        overflow: hidden;
      }

      .num-input input {
        border: none;
        background: transparent;
        text-align: center;
        width: 100%;
        padding: 0.375rem;
      }

      .num-btn {
        width: 24px;
        height: 28px;
        border: none;
        background: var(--bg-4);
        color: var(--text-1);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
        font-family: "SF Mono", Monaco, "Consolas", "Liberation Mono", monospace;
        font-weight: 600;
        line-height: 1;
        transition: all 0.1s;
      }

      .num-btn .num-glyph {
        display: inline-block;
        transform: translateY(-1.5px);
      }

      .num-btn:hover {
        background: var(--accent);
        color: white;
      }

      .linked-row {
        display: flex;
        align-items: flex-end;
        gap: 0.375rem;
      }

      .link-btn {
        width: 24px;
        height: 28px;
        border: none;
        background: transparent;
        color: var(--text-2);
        cursor: pointer;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        margin-bottom: 1px;
      }

      .link-btn.active {
        color: var(--accent);
      }

      .link-btn:hover {
        background: var(--bg-3);
      }

      .ratio-badge {
        text-align: center;
        padding: 0.375rem;
        background: var(--accent-soft);
        border-radius: 6px;
        margin-bottom: 0.5rem;
      }

      .ratio-text {
        font-size: 1.125rem;
        font-weight: 700;
        color: var(--accent);
        font-family: "SF Mono", Monaco, monospace;
      }

      .ratio-label {
        font-size: 0.5625rem;
        color: var(--text-2);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .color-field {
        display: flex;
        align-items: center;
        gap: 0.375rem;
      }

      .color-field input[type="color"] {
        width: 28px;
        height: 28px;
        flex-shrink: 0;
      }

      .color-field input[type="text"] {
        flex: 1;
        font-family: "SF Mono", Monaco, monospace;
        font-size: 0.6875rem;
      }

      .slider-compact {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .slider-compact input[type="range"] {
        flex: 1;
      }

      .slider-compact .field-value {
        min-width: 36px;
        text-align: center;
      }

      .slider-label {
        font-size: 0.6875rem;
        color: var(--text-2);
        min-width: 50px;
      }

      /* Modal */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        z-index: 100;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s;
      }

      .modal-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .modal {
        background: var(--bg-1);
        border-radius: 12px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
        width: 420px;
        max-width: calc(100vw - 2rem);
        max-height: calc(100vh - 2rem);
        overflow: hidden;
        transform: scale(0.95);
        transition: transform 0.2s;
      }

      .modal-overlay.show .modal {
        transform: scale(1);
      }

      .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
        border-bottom: 1px solid var(--border);
      }

      .modal-title {
        font-size: 1rem;
        font-weight: 700;
      }

      .modal-close {
        width: 28px;
        height: 28px;
        border: none;
        background: var(--bg-3);
        color: var(--text-1);
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .modal-close:hover {
        background: var(--bg-4);
        color: var(--text-0);
      }

      .modal-tabs {
        display: flex;
        border-bottom: 1px solid var(--border);
        background: var(--bg-2);
      }

      .modal-tab {
        flex: 1;
        padding: 0.75rem;
        border: none;
        background: transparent;
        color: var(--text-2);
        font-size: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.15s;
      }

      .modal-tab:hover {
        color: var(--text-1);
        background: var(--bg-3);
      }

      .modal-tab.active {
        color: var(--accent);
        background: var(--bg-1);
        box-shadow: inset 0 -2px 0 var(--accent);
      }

      .modal-body {
        padding: 1rem;
        max-height: 400px;
        overflow-y: auto;
      }

      .modal-panel {
        display: none;
      }

      .modal-panel.active {
        display: block;
      }

      .export-option {
        background: var(--bg-2);
        border-radius: 8px;
        padding: 0.75rem;
        margin-bottom: 0.75rem;
      }

      .export-option:last-child {
        margin-bottom: 0;
      }

      .export-option-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.75rem;
      }

      .export-option-title {
        font-size: 0.8125rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .export-option-title svg {
        width: 16px;
        height: 16px;
        color: var(--accent);
      }

      .badge {
        font-size: 0.5625rem;
        font-weight: 700;
        text-transform: uppercase;
        padding: 0.125rem 0.375rem;
        border-radius: 4px;
        background: var(--accent-soft);
        color: var(--accent);
      }

      .export-option-desc {
        font-size: 0.6875rem;
        color: var(--text-2);
        margin-bottom: 0.75rem;
      }

      .export-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.375rem;
      }

      .export-size-btn {
        padding: 0.5rem;
        border: 1px solid var(--border);
        background: var(--bg-3);
        color: var(--text-1);
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.6875rem;
        text-align: center;
        transition: all 0.15s;
      }

      .export-size-btn:hover {
        border-color: var(--accent);
        color: var(--accent);
      }

      .export-size-btn.active {
        border-color: var(--accent);
        color: var(--text-0);
        background: var(--bg-4);
      }

      .export-size-btn .size-label {
        font-weight: 600;
      }

      .export-size-btn .size-dim {
        font-size: 0.5625rem;
        color: var(--text-2);
        margin-top: 0.125rem;
      }

      .anim-settings {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
      }

      .progress-container {
        display: none;
        margin-top: 0.75rem;
      }

      .progress-container.show {
        display: block;
      }

      .progress-bar {
        height: 6px;
        background: var(--bg-4);
        border-radius: 3px;
        overflow: hidden;
        margin-bottom: 0.5rem;
      }

      .progress-fill {
        height: 100%;
        background: var(--accent);
        width: 0%;
        transition: width 0.1s;
      }

      .progress-text {
        font-size: 0.6875rem;
        color: var(--text-2);
        text-align: center;
      }

      .full-btn {
        width: 100%;
        padding: 0.625rem;
        border: none;
        background: var(--accent);
        color: var(--bg-0);
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.15s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
      }

      .full-btn:hover {
        filter: brightness(1.1);
      }

      .full-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .full-btn.secondary {
        background: var(--bg-3);
        color: var(--text-1);
      }

      .full-btn.secondary:hover {
        background: var(--bg-4);
      }

      /* ============================================
         MOBILE BOTTOM SHEET - COMPLETE OVERHAUL
         ============================================ */

      /* Hide on desktop */
      .mobile-drag-handle,
      .mobile-fab-container {
        display: none;
      }

      @media (max-width: 768px) {
        :root {
          --sheet-default-peek: 180px;
          --sheet-collapsed-peek: 72px;
          --sheet-drag-resistance: 0.18;
        }

        /* Main layout restructure */
        .main {
          flex-direction: column;
          position: relative;
        }

        /* Canvas takes full available space */
        .canvas-area {
          flex: 1;
          min-height: 0;
          padding-bottom: 0;
        }

        .canvas-wrapper {
          max-width: calc(100% - 1.5rem);
          max-height: calc(100% - 1rem);
        }

        .canvas-frame {
          padding: 8px;
        }

        #preview {
          max-height: none;
          width: 100%;
          height: auto;
        }

        .canvas-info {
          display: none;
        }

        /* Hide desktop export bar */
        .export-bar {
          display: none;
        }

        /* =========== BOTTOM SHEET =========== */
        .sidebar {
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
          width: 100%;
          height: auto;
          max-height: 75vh;
          border-right: none;
          border-top: none;
          border-radius: 20px 20px 0 0;
          box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.25);
          z-index: 50;
          transform: translate3d(0, calc(100% - var(--sheet-default-peek)), 0);
          transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
          will-change: transform;
          padding-bottom: var(--safe-area-bottom);
          -webkit-backface-visibility: hidden;
          backface-visibility: hidden;
        }

        .sidebar::before {
          content: "";
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          height: 20px;
          background: linear-gradient(to bottom, var(--bg-1), var(--bg-1));
          border-radius: 20px 20px 0 0;
          z-index: 1;
        }

        .sidebar.expanded {
          transform: translate3d(0, 0, 0);
        }

        .sidebar.collapsed {
          transform: translate3d(
            0,
            calc(100% - var(--sheet-collapsed-peek)),
            0
          );
        }

        .sidebar.dragging {
          transition: none;
        }

        /* Drag Handle */
        .mobile-drag-handle {
          display: flex;
          flex-direction: column;
          align-items: center;
          padding: 14px 16px 12px;
          min-height: 48px;
          cursor: grab;
          touch-action: none;
          position: relative;
          z-index: 2;
          -webkit-tap-highlight-color: transparent;
          -webkit-touch-callout: none;
          -webkit-user-select: none;
          user-select: none;
          contain: paint;
          background: var(--bg-1);
          isolation: isolate;
        }

        .mobile-drag-handle:active {
          cursor: grabbing;
        }

        .drag-pill {
          width: 44px;
          height: 5px;
          background: var(--text-2);
          opacity: 0.3;
          border-radius: 2px;
          transform: translateZ(0);
          -webkit-backface-visibility: hidden;
          backface-visibility: hidden;
          will-change: width, background-color, opacity;
          transition: background-color 0.2s cubic-bezier(0.4, 0, 0.2, 1),
            width 0.2s cubic-bezier(0.4, 0, 0.2, 1),
            opacity 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .mobile-drag-handle.dragging .drag-pill {
          background: var(--accent);
          opacity: 1;
          width: 56px;
          transition: none;
        }

        .mobile-drag-handle.force-repaint {
          transform: translateZ(0) scale(1.0001);
        }

        .drag-hint {
          font-size: 0.625rem;
          color: var(--text-2);
          margin-top: 6px;
          text-transform: uppercase;
          letter-spacing: 0.05em;
          opacity: 0.5;
          font-weight: 500;
        }

        .sidebar.expanded .drag-hint::after {
          content: "Swipe down to minimize";
        }

        .sidebar:not(.expanded):not(.collapsed) .drag-hint::after {
          content: "Swipe to adjust";
        }

        .sidebar.collapsed .drag-hint::after {
          content: "Swipe up for controls";
        }

        /* Tabs - Pill Style */
        .tabs {
          display: flex;
          gap: 8px;
          padding: 4px 14px 10px;
          background: transparent;
          border-bottom: none;
          overflow-x: auto;
          -webkit-overflow-scrolling: touch;
          scrollbar-width: none;
        }

        .tabs::-webkit-scrollbar {
          display: none;
        }

        .tab {
          flex: 1;
          min-width: 0;
          padding: 12px 14px;
          border-radius: 12px;
          background: var(--bg-2);
          border: 1px solid transparent;
          flex-direction: row;
          gap: 8px;
          justify-content: center;
          text-align: center;
          font-size: 0.8125rem;
          font-weight: 500;
          text-transform: none;
          letter-spacing: 0;
        }

        .tab svg {
          width: 19px;
          height: 19px;
        }

        .tab.active {
          background: rgba(var(--accent-rgb), 0.12);
          border-color: rgba(var(--accent-rgb), 0.3);
          box-shadow: none;
        }

        /* Tab Content */
        .tab-content {
          padding: 0 16px 16px;
          max-height: calc(75vh - 160px);
          -webkit-overflow-scrolling: touch;
        }

        /* Hide footer on mobile */
        .sidebar-footer {
          display: none;
        }

        /* =========== LARGER TOUCH TARGETS =========== */

        /* Group styling */
        .group {
          margin-bottom: 14px;
        }

        .group-title {
          font-size: 0.6875rem;
          margin-bottom: 8px;
          padding: 0;
          font-weight: 600;
        }

        .group-content {
          padding: 12px;
          border-radius: 14px;
        }

        /* Presets Grid - Larger */
        .presets {
          grid-template-columns: repeat(5, 1fr);
          gap: 8px;
        }

        .preset {
          border-radius: 10px;
          padding: 6px;
          min-height: 50px;
          border: 1px solid var(--bg-3);
        }

        .preset:active {
          transform: scale(0.94);
          background: rgba(var(--accent-rgb), 0.1);
          border-color: rgba(var(--accent-rgb), 0.3);
        }

        /* Ratio Badge */
        .ratio-badge {
          padding: 12px;
          border-radius: 13px;
          margin-bottom: 12px;
        }

        .ratio-text {
          font-size: 1.375rem;
          font-weight: 600;
        }

        .ratio-label {
          font-size: 0.6875rem;
          margin-top: 2px;
          font-weight: 500;
        }

        /* Number Inputs - Much Larger */
        .num-input {
          border-radius: 12px;
          overflow: hidden;
          height: 52px;
        }

        .num-btn {
          width: 52px;
          height: 52px;
          font-size: 1.375rem;
        }

        .num-btn:active {
          background: var(--accent);
          color: white;
        }

        .num-input input {
          font-size: 1.125rem;
          font-weight: 600;
          padding: 14px 8px;
        }

        .field-label {
          font-size: 0.75rem;
          margin-bottom: 7px;
          color: var(--text-1);
          font-weight: 500;
        }

        /* Sliders - Larger Touch Area */
        .slider-compact {
          gap: 12px;
          padding: 8px 0;
          min-height: 48px;
          align-items: center;
        }

        .slider-label {
          font-size: 0.875rem;
          min-width: 70px;
          color: var(--text-1);
        }

        input[type="range"] {
          height: 28px;
          background: transparent;
          border-radius: 4px;
          padding: 0;
        }

        input[type="range"]::-webkit-slider-runnable-track {
          height: 8px;
          background: var(--bg-4);
          border-radius: 4px;
        }

        input[type="range"]::-webkit-slider-thumb {
          width: 28px;
          height: 28px;
          margin-top: -10px;
          background: #fff;
          border: none;
          border-radius: 50%;
          box-shadow: 0 2px 6px rgba(0, 0, 0, 0.35);
        }

        input[type="range"]::-moz-range-track {
          height: 8px;
          background: var(--bg-4);
          border-radius: 4px;
        }

        input[type="range"]::-moz-range-thumb {
          width: 28px;
          height: 28px;
          background: #fff;
          border: none;
          border-radius: 50%;
          box-shadow: 0 2px 6px rgba(0, 0, 0, 0.35);
        }

        .slider-compact .field-value {
          min-width: 48px;
          font-size: 0.875rem;
          padding: 6px 10px;
          border-radius: 8px;
        }

        /* Toggles - Larger */
        .toggle-row {
          padding: 10px 0;
          min-height: 48px;
        }

        .toggle-label {
          font-size: 0.875rem;
          font-weight: 500;
        }

        .toggle {
          width: 48px;
          height: 28px;
          border-radius: 14px;
        }

        .toggle::after {
          width: 22px;
          height: 22px;
          top: 3px;
          left: 3px;
        }

        .toggle.active::after {
          transform: translateX(20px);
        }

        /* Selects - Larger */
        select,
        input[type="number"],
        input[type="text"] {
          padding: 13px 14px;
          font-size: 0.9375rem;
          border-radius: 11px;
          min-height: 48px;
        }

        /* Color Fields */
        .color-field {
          gap: 10px;
        }

        .color-field input[type="color"] {
          width: 48px;
          height: 48px;
          border-radius: 11px;
          padding: 4px;
        }

        .color-field input[type="text"] {
          font-size: 0.875rem;
        }

        /* Play Button */
        .play-btn {
          height: 52px;
          border-radius: 13px;
          font-size: 0.9375rem;
          font-weight: 600;
          margin-top: 10px;
        }

        .play-btn svg {
          width: 19px;
          height: 19px;
        }

        /* Row gaps */
        .row {
          gap: 10px;
          margin-bottom: 10px;
        }

        /* Linked Row */
        .linked-row {
          gap: 8px;
        }

        .link-btn {
          width: 42px;
          height: 48px;
          border-radius: 10px;
        }

        .link-btn svg {
          width: 19px;
          height: 19px;
        }

        /* Quick Size Buttons */
        .export-btn.secondary {
          padding: 13px 11px;
          border-radius: 10px;
          font-size: 0.875rem;
        }

        /* =========== FLOATING ACTION BUTTONS =========== */
        .mobile-fab-container {
          display: flex;
          position: fixed;
          bottom: 200px;
          right: 20px;
          z-index: 45;
          flex-direction: column;
          gap: 10px;
          transition: opacity 0.25s cubic-bezier(0.4, 0, 0.2, 1),
            transform 0.25s cubic-bezier(0.4, 0, 0.2, 1),
            bottom 0.35s cubic-bezier(0.32, 0.72, 0, 1);
        }

        /* When collapsed, move FABs down a bit */
        .sidebar.collapsed ~ .canvas-area .mobile-fab-container,
        .main:has(.sidebar.collapsed) .mobile-fab-container {
          bottom: 92px;
        }

        /* When expanded, hide FABs */
        .sidebar.expanded ~ .canvas-area .mobile-fab-container,
        .main:has(.sidebar.expanded) .mobile-fab-container {
          opacity: 0;
          pointer-events: none;
          transform: translateY(16px);
        }

        .mobile-fab {
          width: 48px;
          height: 48px;
          border-radius: 14px;
          border: none;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
          transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1),
            box-shadow 0.2s cubic-bezier(0.4, 0, 0.2, 1);
          position: relative;
          backdrop-filter: blur(8px);
        }

        /* Big invisible hitbox for easier tapping */
        .mobile-fab::before {
          content: "";
          position: absolute;
          inset: -8px;
        }

        .mobile-fab:active {
          transform: scale(0.9);
          box-shadow: 0 1px 6px rgba(0, 0, 0, 0.2);
        }

        .mobile-fab svg {
          width: 22px;
          height: 22px;
        }

        .mobile-fab.primary {
          background: var(--accent);
          color: white;
        }

        .mobile-fab.secondary {
          background: rgba(var(--accent-rgb), 0.1);
          color: var(--accent);
          border: 1px solid rgba(var(--accent-rgb), 0.2);
        }

        /* =========== MODAL MOBILE STYLES =========== */
        .modal-overlay {
          align-items: flex-end;
          padding: 0;
        }

        .modal {
          width: 100%;
          max-width: 100%;
          border-radius: 20px 20px 0 0;
          max-height: 85vh;
          margin: 0;
        }

        .modal-header {
          padding: 18px 20px;
        }

        .modal-title {
          font-size: 1.125rem;
          font-weight: 600;
        }

        .modal-close {
          width: 38px;
          height: 38px;
          border-radius: 11px;
        }

        .modal-tabs {
          gap: 0;
        }

        .modal-tab {
          padding: 14px;
          font-size: 0.875rem;
        }

        .modal-body {
          padding: 14px 18px;
          max-height: 60vh;
          padding-bottom: calc(14px + var(--safe-area-bottom));
        }

        .export-option {
          padding: 14px;
          border-radius: 14px;
          margin-bottom: 10px;
        }

        .export-option-title {
          font-size: 0.9375rem;
          font-weight: 600;
        }

        .export-option-desc {
          font-size: 0.75rem;
        }

        .export-grid {
          gap: 8px;
        }

        .export-size-btn {
          padding: 13px 8px;
          border-radius: 11px;
          font-size: 0.8125rem;
        }

        .export-size-btn .size-dim {
          font-size: 0.6875rem;
        }

        .anim-settings {
          gap: 10px;
        }

        .anim-settings .field-label {
          font-size: 0.75rem;
        }

        .full-btn {
          padding: 14px;
          border-radius: 13px;
          font-size: 0.9375rem;
          font-weight: 600;
          min-height: 52px;
        }

        /* Header mobile adjustments */
        header {
          padding: 0.625rem 16px;
          height: 56px;
        }

        .logo {
          font-size: 0.9375rem;
          font-weight: 600;
        }

        .header-actions {
          gap: 0.5rem;
        }

        .icon-btn {
          width: 44px;
          height: 44px;
          border-radius: 12px;
          position: relative;
        }

        /* Big invisible hitbox */
        .icon-btn::before {
          content: "";
          position: absolute;
          inset: -6px;
        }

        .icon-btn svg {
          width: 22px;
          height: 22px;
        }

        .divider {
          height: 24px;
          margin: 0 0.125rem;
        }
      }

      /* Extra small screens */
      @media (max-width: 380px) {
        .presets {
          grid-template-columns: repeat(5, 1fr);
          gap: 6px;
        }

        .preset {
          min-height: 44px;
        }

        .tabs {
          padding: 4px 8px 10px;
        }

        .tab {
          padding: 12px 10px;
          font-size: 0.75rem;
        }

        .tab svg {
          width: 18px;
          height: 18px;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="logo">
        <span>Lissajous Lab</span>
      </div>
      <div class="header-actions">
        <button class="icon-btn" onclick="randomize()" title="Randomize">
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M16 3h5v5" />
            <path d="M4 20L21 3" />
            <path d="M21 16v5h-5" />
            <path d="M15 15l6 6" />
            <path d="M4 4l5 5" />
          </svg>
        </button>
        <button class="icon-btn" onclick="resetAll()" title="Reset">
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />
            <path d="M3 3v5h5" />
          </svg>
        </button>
        <div class="divider"></div>
        <button
          class="icon-btn"
          id="themeBtn"
          onclick="toggleTheme()"
          title="Toggle theme"
        >
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <circle cx="12" cy="12" r="5" />
            <path
              d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"
            />
          </svg>
        </button>
      </div>
    </header>

    <div class="main">
      <aside class="sidebar" id="sidebar">
        <!-- Mobile Drag Handle -->
        <div class="mobile-drag-handle" id="dragHandle">
          <div class="drag-pill"></div>
          <div class="drag-hint"></div>
        </div>

        <div class="tabs">
          <button class="tab active" data-tab="shape">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <circle cx="12" cy="12" r="10" />
            </svg>
            Shape
          </button>
          <button class="tab" data-tab="style">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"
              />
            </svg>
            Style
          </button>
          <button class="tab" data-tab="canvas">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <rect x="3" y="3" width="18" height="18" rx="2" />
              <path d="M3 9h18M9 21V9" />
            </svg>
            Canvas
          </button>
        </div>

        <div class="tab-content">
          <div class="tab-panel active" id="panel-shape">
            <div class="group">
              <div class="group-title">Presets</div>
              <div class="group-content">
                <div class="presets" id="presets"></div>
              </div>
            </div>

            <div class="group">
              <div class="group-title">Frequency Ratio</div>
              <div class="group-content">
                <div class="ratio-badge">
                  <div class="ratio-text" id="ratio-display">3:4</div>
                  <div class="ratio-label">A : B ratio</div>
                </div>
                <div class="row">
                  <div class="field">
                    <div class="field-label">Freq A</div>
                    <div class="num-input">
                      <button class="num-btn" onclick="adjustNum('freqA', -1)">
                        <span class="num-glyph">−</span>
                      </button>
                      <input
                        type="number"
                        id="freqA"
                        value="3"
                        min="1"
                        max="20"
                      />
                      <button class="num-btn" onclick="adjustNum('freqA', 1)">
                        <span class="num-glyph">+</span>
                      </button>
                    </div>
                  </div>
                  <div class="field">
                    <div class="field-label">Freq B</div>
                    <div class="num-input">
                      <button class="num-btn" onclick="adjustNum('freqB', -1)">
                        <span class="num-glyph">−</span>
                      </button>
                      <input
                        type="number"
                        id="freqB"
                        value="4"
                        min="1"
                        max="20"
                      />
                      <button class="num-btn" onclick="adjustNum('freqB', 1)">
                        <span class="num-glyph">+</span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="group">
              <div class="group-title">Transform</div>
              <div class="group-content">
                <div class="slider-compact">
                  <span class="slider-label">Phase</span>
                  <input type="range" id="phase" min="0" max="360" value="0" />
                  <span class="field-value" id="phase-val">0°</span>
                </div>
                <div class="slider-compact" style="margin-top: 0.5rem">
                  <span class="slider-label">Rotation</span>
                  <input
                    type="range"
                    id="rotation"
                    min="0"
                    max="360"
                    value="0"
                  />
                  <span class="field-value" id="rotation-val">0°</span>
                </div>
                <div class="slider-compact" style="margin-top: 0.5rem">
                  <span class="slider-label">Scale</span>
                  <input
                    type="range"
                    id="scale"
                    min="20"
                    max="100"
                    value="85"
                  />
                  <span class="field-value" id="scale-val">85%</span>
                </div>
                <div class="slider-compact" style="margin-top: 0.5rem">
                  <span class="slider-label">Points</span>
                  <input
                    type="range"
                    id="resolution"
                    min="100"
                    max="2000"
                    step="50"
                    value="500"
                  />
                  <span class="field-value" id="resolution-val">500</span>
                </div>
              </div>
            </div>
          </div>

          <div class="tab-panel" id="panel-style">
            <div class="group">
              <div class="group-title">Stroke</div>
              <div class="group-content">
                <div class="row">
                  <div class="field">
                    <div class="field-label">Color</div>
                    <div class="color-field">
                      <input type="color" id="strokeColor" value="#6366f1" />
                      <input type="text" id="strokeHex" value="#6366f1" />
                    </div>
                  </div>
                </div>
                <div class="toggle-row" style="margin-top: 0.5rem">
                  <span class="toggle-label">Gradient</span>
                  <div
                    class="toggle"
                    id="gradientToggle"
                    onclick="toggle(this)"
                  ></div>
                </div>
                <div
                  class="row"
                  id="gradientRow"
                  style="display: none; margin-top: 0.5rem"
                >
                  <div class="field">
                    <div class="field-label">End Color</div>
                    <div class="color-field">
                      <input type="color" id="strokeColor2" value="#ec4899" />
                      <input type="text" id="strokeHex2" value="#ec4899" />
                    </div>
                  </div>
                </div>
                <div class="slider-compact" style="margin-top: 0.5rem">
                  <span class="slider-label">Width</span>
                  <input
                    type="range"
                    id="strokeWidth"
                    min="0.5"
                    max="15"
                    step="0.5"
                    value="2"
                  />
                  <span class="field-value" id="strokeWidth-val">2</span>
                </div>
                <div class="slider-compact" style="margin-top: 0.5rem">
                  <span class="slider-label">Opacity</span>
                  <input
                    type="range"
                    id="strokeOpacity"
                    min="0"
                    max="100"
                    value="100"
                  />
                  <span class="field-value" id="strokeOpacity-val">100%</span>
                </div>
                <div class="row" style="margin-top: 0.5rem">
                  <div class="field">
                    <div class="field-label">Cap</div>
                    <select id="lineCap">
                      <option value="round">Round</option>
                      <option value="butt">Butt</option>
                      <option value="square">Square</option>
                    </select>
                  </div>
                  <div class="field">
                    <div class="field-label">Join</div>
                    <select id="lineJoin">
                      <option value="round">Round</option>
                      <option value="miter">Miter</option>
                      <option value="bevel">Bevel</option>
                    </select>
                  </div>
                </div>
                <div class="field" style="margin-top: 0.5rem">
                  <div class="field-label">Dash Pattern</div>
                  <select id="dashPattern">
                    <option value="">Solid</option>
                    <option value="5,5">Dashed</option>
                    <option value="2,4">Dotted</option>
                    <option value="10,5,2,5">Dash-Dot</option>
                    <option value="20,5">Long Dash</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="group">
              <div class="group-title">Fill</div>
              <div class="group-content">
                <div class="toggle-row">
                  <span class="toggle-label">Enable Fill</span>
                  <div
                    class="toggle"
                    id="fillToggle"
                    onclick="toggle(this)"
                  ></div>
                </div>
                <div id="fillOptions" style="display: none; margin-top: 0.5rem">
                  <div class="row">
                    <div class="field">
                      <div class="field-label">Color</div>
                      <div class="color-field">
                        <input type="color" id="fillColor" value="#6366f1" />
                        <input type="text" id="fillHex" value="#6366f1" />
                      </div>
                    </div>
                  </div>
                  <div class="slider-compact" style="margin-top: 0.5rem">
                    <span class="slider-label">Opacity</span>
                    <input
                      type="range"
                      id="fillOpacity"
                      min="0"
                      max="100"
                      value="15"
                    />
                    <span class="field-value" id="fillOpacity-val">15%</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="tab-panel" id="panel-canvas">
            <div class="group">
              <div class="group-title">Dimensions</div>
              <div class="group-content">
                <div class="linked-row">
                  <div class="field">
                    <div class="field-label">Width</div>
                    <input
                      type="number"
                      id="canvasWidth"
                      value="400"
                      min="50"
                      max="2000"
                    />
                  </div>
                  <button
                    class="link-btn active"
                    id="linkBtn"
                    onclick="toggleLink()"
                    title="Link dimensions"
                  >
                    <svg
                      width="14"
                      height="14"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path
                        d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"
                      />
                      <path
                        d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"
                      />
                    </svg>
                  </button>
                  <div class="field">
                    <div class="field-label">Height</div>
                    <input
                      type="number"
                      id="canvasHeight"
                      value="400"
                      min="50"
                      max="2000"
                    />
                  </div>
                </div>
                <div class="row" style="margin-top: 0.5rem">
                  <button
                    class="export-btn secondary"
                    style="flex: 1; justify-content: center"
                    onclick="setSize(400)"
                  >
                    400
                  </button>
                  <button
                    class="export-btn secondary"
                    style="flex: 1; justify-content: center"
                    onclick="setSize(512)"
                  >
                    512
                  </button>
                  <button
                    class="export-btn secondary"
                    style="flex: 1; justify-content: center"
                    onclick="setSize(800)"
                  >
                    800
                  </button>
                  <button
                    class="export-btn secondary"
                    style="flex: 1; justify-content: center"
                    onclick="setSize(1024)"
                  >
                    1024
                  </button>
                </div>
              </div>
            </div>

            <div class="group">
              <div class="group-title">Background</div>
              <div class="group-content">
                <div class="toggle-row">
                  <span class="toggle-label">Background Fill</span>
                  <div
                    class="toggle"
                    id="bgFillToggle"
                    onclick="toggle(this)"
                  ></div>
                </div>
                <div id="bgColorRow" style="display: none; margin-top: 0.5rem">
                  <div class="field">
                    <div class="field-label">Color</div>
                    <div class="color-field">
                      <input type="color" id="bgColor" value="#0a0a0f" />
                      <input type="text" id="bgHex" value="#0a0a0f" />
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="group">
              <div class="group-title">Preview Animation</div>
              <div class="group-content">
                <div class="slider-compact">
                  <span class="slider-label">Speed</span>
                  <input
                    type="range"
                    id="animSpeed"
                    min="0.2"
                    max="3"
                    step="0.1"
                    value="1"
                  />
                  <span class="field-value" id="speed-val">1×</span>
                </div>
                <button class="play-btn" id="playBtn" onclick="toggleAnim()">
                  <svg viewBox="0 0 24 24" fill="currentColor">
                    <polygon points="5 3 19 12 5 21" />
                  </svg>
                  <span id="playBtnText">Play Animation</span>
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="sidebar-footer">
          Made by
          <a
            href="https://pierrelouis.net"
            target="_blank"
            rel="noopener noreferrer"
            >Pierre-Louis</a
          >
        </div>
      </aside>

      <main class="canvas-area">
        <div class="canvas-bg"></div>
        <div class="canvas-wrapper">
          <div class="canvas-frame">
            <svg id="preview" width="400" height="400"></svg>
          </div>
          <div class="canvas-info" id="canvas-info">400 × 400</div>
        </div>
        <div class="export-bar">
          <button class="export-btn primary" onclick="openExportModal()">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
              <polyline points="7 10 12 15 17 10" />
              <line x1="12" y1="15" x2="12" y2="3" />
            </svg>
            Export
          </button>
          <button class="export-btn secondary" onclick="quickCopySVG(this)">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <rect x="9" y="9" width="13" height="13" rx="2" />
              <path
                d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"
              />
            </svg>
            Copy
          </button>
        </div>

        <!-- Mobile FABs -->
        <div class="mobile-fab-container" id="mobileFabs">
          <button
            class="mobile-fab secondary"
            onclick="toggleAnim()"
            id="mobileFabPlay"
            title="Play/Pause"
          >
            <svg viewBox="0 0 24 24" fill="currentColor">
              <polygon points="5 3 19 12 5 21" />
            </svg>
          </button>
          <button
            class="mobile-fab primary"
            onclick="openExportModal()"
            title="Export"
          >
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
              <polyline points="7 10 12 15 17 10" />
              <line x1="12" y1="15" x2="12" y2="3" />
            </svg>
          </button>
        </div>
      </main>
    </div>

    <!-- Export Modal -->
    <div class="modal-overlay" id="exportModal">
      <div class="modal">
        <div class="modal-header">
          <div class="modal-title">Export</div>
          <button class="modal-close" onclick="closeExportModal()">
            <svg
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M18 6L6 18M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div class="modal-tabs">
          <button class="modal-tab active" data-modal-tab="image">Image</button>
          <button class="modal-tab" data-modal-tab="animation">
            Animation
          </button>
        </div>
        <div class="modal-body">
          <!-- Image Panel -->
          <div class="modal-panel active" id="modal-panel-image">
            <div class="export-option">
              <div class="export-option-header">
                <div class="export-option-title">
                  <svg
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path
                      d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                    />
                    <polyline points="14 2 14 8 20 8" />
                  </svg>
                  SVG Vector
                </div>
                <span class="badge">Recommended</span>
              </div>
              <div class="export-option-desc">
                Scalable vector format. Perfect for web, print, or further
                editing.
              </div>
              <div class="row">
                <button class="full-btn" onclick="downloadSVG(this)">
                  <svg
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                    <polyline points="7 10 12 15 17 10" />
                    <line x1="12" y1="15" x2="12" y2="3" />
                  </svg>
                  Download SVG
                </button>
                <button
                  class="full-btn secondary"
                  onclick="copySVG(this)"
                  style="flex: 0.5"
                >
                  <svg
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <rect x="9" y="9" width="13" height="13" rx="2" />
                    <path
                      d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"
                    />
                  </svg>
                  Copy
                </button>
              </div>
            </div>

            <div class="export-option">
              <div class="export-option-header">
                <div class="export-option-title">
                  <svg
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <rect x="3" y="3" width="18" height="18" rx="2" />
                    <circle cx="8.5" cy="8.5" r="1.5" />
                    <path d="M21 15l-5-5L5 21" />
                  </svg>
                  PNG Bitmap
                </div>
              </div>
              <div class="export-option-desc">
                Raster image with transparency support. Choose a size
                multiplier.
              </div>
              <div class="export-grid">
                <button
                  class="export-size-btn png-size-btn active"
                  data-scale="1"
                  onclick="setPNGScale(1)"
                >
                  <div class="size-label">1×</div>
                  <div class="size-dim" id="png-1x">400×400</div>
                </button>
                <button
                  class="export-size-btn png-size-btn"
                  data-scale="2"
                  onclick="setPNGScale(2)"
                >
                  <div class="size-label">2×</div>
                  <div class="size-dim" id="png-2x">800×800</div>
                </button>
                <button
                  class="export-size-btn png-size-btn"
                  data-scale="4"
                  onclick="setPNGScale(4)"
                >
                  <div class="size-label">4×</div>
                  <div class="size-dim" id="png-4x">1600×1600</div>
                </button>
              </div>
              <div class="row" style="margin-top: 0.75rem">
                <button class="full-btn" onclick="downloadPNG(this)">
                  <svg
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                    <polyline points="7 10 12 15 17 10" />
                    <line x1="12" y1="15" x2="12" y2="3" />
                  </svg>
                  Download PNG
                </button>
                <button
                  class="full-btn secondary"
                  onclick="copyPNG(this)"
                  style="flex: 0.6"
                >
                  <svg
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <rect x="9" y="9" width="13" height="13" rx="2" />
                    <path
                      d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"
                    />
                  </svg>
                  Copy
                </button>
              </div>
            </div>
          </div>

          <!-- Animation Panel -->
          <div class="modal-panel" id="modal-panel-animation">
            <div class="export-option">
              <div class="export-option-header">
                <div class="export-option-title">
                  <svg
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <rect x="2" y="2" width="20" height="20" rx="2.18" />
                    <path d="M10 8l6 4-6 4V8z" />
                  </svg>
                  Animated GIF
                </div>
                <span class="badge">Universal</span>
              </div>
              <div class="export-option-desc">
                Looping animation. Works everywhere.
              </div>
              <div class="anim-settings">
                <div class="field">
                  <div class="field-label">Duration (seconds)</div>
                  <input
                    type="number"
                    id="gifDuration"
                    min="0.5"
                    max="20"
                    step="0.5"
                    value="2"
                  />
                </div>
                <div class="field">
                  <div class="field-label">Frame Rate</div>
                  <select id="gifFps">
                    <option value="15">15 fps</option>
                    <option value="24" selected>24 fps</option>
                    <option value="30">30 fps</option>
                  </select>
                </div>
                <div class="field">
                  <div class="field-label">Size (px)</div>
                  <input
                    type="number"
                    id="gifSize"
                    min="100"
                    max="1600"
                    step="50"
                    value="400"
                  />
                </div>
                <div class="field">
                  <div class="field-label">Quality</div>
                  <select id="gifQuality">
                    <option value="5">High (slower)</option>
                    <option value="10" selected>Medium</option>
                    <option value="20">Low (faster)</option>
                  </select>
                </div>
              </div>
              <button class="full-btn" id="gifBtn" onclick="exportGIF()">
                <svg
                  width="14"
                  height="14"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                  <polyline points="7 10 12 15 17 10" />
                  <line x1="12" y1="15" x2="12" y2="3" />
                </svg>
                Generate GIF
              </button>
              <div class="progress-container" id="gifProgress">
                <div class="progress-bar">
                  <div class="progress-fill" id="gifProgressFill"></div>
                </div>
                <div class="progress-text" id="gifProgressText">
                  Rendering frames...
                </div>
              </div>
            </div>

            <div class="export-option">
              <div class="export-option-header">
                <div class="export-option-title">
                  <svg
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <polygon points="23 7 16 12 23 17 23 7" />
                    <rect x="1" y="5" width="15" height="14" rx="2" />
                  </svg>
                  WebM Video
                </div>
                <span class="badge">Smaller size</span>
              </div>
              <div class="export-option-desc">
                Modern video format with great compression. Supported in most
                browsers.
              </div>
              <div class="anim-settings">
                <div class="field">
                  <div class="field-label">Duration (seconds)</div>
                  <input
                    type="number"
                    id="webmDuration"
                    min="0.5"
                    max="20"
                    step="0.5"
                    value="2"
                  />
                </div>
                <div class="field">
                  <div class="field-label">Size (px)</div>
                  <input
                    type="number"
                    id="webmSize"
                    min="200"
                    max="2400"
                    step="50"
                    value="600"
                  />
                </div>
              </div>
              <button class="full-btn" id="webmBtn" onclick="exportWebM()">
                <svg
                  width="14"
                  height="14"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                  <polyline points="7 10 12 15 17 10" />
                  <line x1="12" y1="15" x2="12" y2="3" />
                </svg>
                Record WebM
              </button>
              <div class="progress-container" id="webmProgress">
                <div class="progress-bar">
                  <div class="progress-fill" id="webmProgressFill"></div>
                </div>
                <div class="progress-text" id="webmProgressText">
                  Recording...
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <canvas id="renderCanvas" style="display: none"></canvas>

    <script>
      // GIF Encoder (minimal LZW-based encoder)
      class GIFEncoder {
        constructor(width, height) {
          this.width = width;
          this.height = height;
          this.frames = [];
          this.delay = 100;
        }

        setDelay(ms) {
          this.delay = ms;
        }

        addFrame(ctx) {
          const imageData = ctx.getImageData(0, 0, this.width, this.height);
          const pixels = this.quantize(imageData.data);
          this.frames.push(pixels);
        }

        quantize(data) {
          const palette = this.buildPalette(data);
          const indexed = new Uint8Array(this.width * this.height);
          for (let i = 0; i < data.length; i += 4) {
            const r = data[i],
              g = data[i + 1],
              b = data[i + 2];
            indexed[i / 4] = this.findClosest(palette, r, g, b);
          }
          return { indexed, palette };
        }

        buildPalette(data) {
          const colors = new Map();
          for (let i = 0; i < data.length; i += 4) {
            const key = (data[i] << 16) | (data[i + 1] << 8) | data[i + 2];
            colors.set(key, (colors.get(key) || 0) + 1);
          }
          const sorted = [...colors.entries()]
            .sort((a, b) => b[1] - a[1])
            .slice(0, 256);
          const palette = new Uint8Array(256 * 3);
          sorted.forEach(([color], i) => {
            palette[i * 3] = (color >> 16) & 255;
            palette[i * 3 + 1] = (color >> 8) & 255;
            palette[i * 3 + 2] = color & 255;
          });
          return palette;
        }

        findClosest(palette, r, g, b) {
          let minDist = Infinity,
            idx = 0;
          for (let i = 0; i < 256; i++) {
            const dr = palette[i * 3] - r;
            const dg = palette[i * 3 + 1] - g;
            const db = palette[i * 3 + 2] - b;
            const dist = dr * dr + dg * dg + db * db;
            if (dist < minDist) {
              minDist = dist;
              idx = i;
            }
          }
          return idx;
        }

        finish() {
          const bytes = [];
          const write = (...b) => bytes.push(...b);
          const writeStr = (s) =>
            [...s].forEach((c) => bytes.push(c.charCodeAt(0)));

          writeStr("GIF89a");
          write(this.width & 255, this.width >> 8);
          write(this.height & 255, this.height >> 8);
          write(0xf7, 0, 0);

          if (this.frames.length > 0) {
            for (let i = 0; i < 256 * 3; i++) {
              write(this.frames[0].palette[i] || 0);
            }
          }

          write(0x21, 0xff, 0x0b);
          writeStr("NETSCAPE2.0");
          write(0x03, 0x01, 0x00, 0x00, 0x00);

          for (const frame of this.frames) {
            write(0x21, 0xf9, 0x04, 0x00);
            write((this.delay / 10) & 255, (this.delay / 10) >> 8);
            write(0x00, 0x00);

            write(0x2c, 0, 0, 0, 0);
            write(this.width & 255, this.width >> 8);
            write(this.height & 255, this.height >> 8);
            write(0x00);

            const lzw = this.lzwEncode(frame.indexed, 8);
            write(8);
            for (let i = 0; i < lzw.length; i += 255) {
              const chunk = lzw.slice(i, i + 255);
              write(chunk.length, ...chunk);
            }
            write(0x00);
          }

          write(0x3b);
          return new Uint8Array(bytes);
        }

        lzwEncode(data, minCodeSize) {
          const clearCode = 1 << minCodeSize;
          const eoiCode = clearCode + 1;
          let codeSize = minCodeSize + 1;
          let nextCode = eoiCode + 1;
          const table = new Map();
          const output = [];
          let bits = 0,
            buf = 0;

          const emit = (code) => {
            buf |= code << bits;
            bits += codeSize;
            while (bits >= 8) {
              output.push(buf & 255);
              buf >>= 8;
              bits -= 8;
            }
          };

          emit(clearCode);
          let prefix = data[0];

          for (let i = 1; i < data.length; i++) {
            const suffix = data[i];
            const key = (prefix << 12) | suffix;
            if (table.has(key)) {
              prefix = table.get(key);
            } else {
              emit(prefix);
              if (nextCode < 4096) {
                table.set(key, nextCode++);
                if (nextCode > 1 << codeSize && codeSize < 12) codeSize++;
              }
              prefix = suffix;
            }
          }

          emit(prefix);
          emit(eoiCode);
          if (bits > 0) output.push(buf);

          return output;
        }
      }

      const presets = [
        { a: 1, b: 2, p: 90 },
        { a: 3, b: 2, p: 0 },
        { a: 3, b: 4, p: 0 },
        { a: 5, b: 4, p: 90 },
        { a: 3, b: 5, p: 45 },
        { a: 7, b: 6, p: 0 },
        { a: 1, b: 1, p: 90 },
        { a: 2, b: 3, p: 30 },
        { a: 5, b: 6, p: 60 },
        { a: 4, b: 5, p: 0 },
      ];

      let isAnimating = false,
        animId = null,
        animPhase = 0,
        linkedDims = true;
      let pngScale = 1;
      let currentHue = 240;
      const statusTimers = new WeakMap();
      const checkIcon = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>`;

      // Mobile bottom sheet state
      let sheetState = "default"; // 'collapsed', 'default', 'expanded'
      let isDragging = false;
      let startY = 0;
      let startTranslate = 0;
      let currentTranslate = 0;
      let dragStartState = "default";
      let dragVelocity = 0;
      let lastMoveTime = 0;
      let lastMoveTranslate = 0;
      let dragConfig = null;
      let dragSnapPoints = null;
      let repaintFrame = null;

      function setDragActive(isActive) {
        const sidebar = document.getElementById("sidebar");
        const dragHandle = document.getElementById("dragHandle");
        if (sidebar) {
          sidebar.classList.toggle("dragging", isActive);
        }
        if (dragHandle) {
          dragHandle.classList.toggle("dragging", isActive);
        }
      }

      function forceHandleRepaint() {
        const dragHandle = document.getElementById("dragHandle");
        if (!dragHandle) return;
        dragHandle.classList.add("force-repaint");
        void dragHandle.offsetHeight;
        if (repaintFrame) {
          cancelAnimationFrame(repaintFrame);
        }
        repaintFrame = requestAnimationFrame(() => {
          dragHandle.classList.remove("force-repaint");
          repaintFrame = null;
        });
      }

      function getSheetConfig() {
        const sidebar = document.getElementById("sidebar");
        if (!sidebar) {
          return { maxTranslate: 0, defaultTranslate: 0, resistance: 0.18 };
        }
        const style = window.getComputedStyle(sidebar);
        const collapsedPeek = parseFloat(
          style.getPropertyValue("--sheet-collapsed-peek")
        );
        const defaultPeek = parseFloat(
          style.getPropertyValue("--sheet-default-peek")
        );
        const resistance = parseFloat(
          style.getPropertyValue("--sheet-drag-resistance")
        );
        const safeCollapsed = Number.isFinite(collapsedPeek)
          ? collapsedPeek
          : 72;
        const safeDefault = Number.isFinite(defaultPeek) ? defaultPeek : 180;
        const safeResistance = Number.isFinite(resistance) ? resistance : 0.18;
        const maxTranslate = Math.max(0, sidebar.offsetHeight - safeCollapsed);
        const defaultTranslate = Math.max(
          0,
          sidebar.offsetHeight - safeDefault
        );

        return {
          maxTranslate,
          defaultTranslate,
          resistance: safeResistance,
        };
      }

      function getSnapPoints(config) {
        return {
          expanded: 0,
          default: config.defaultTranslate,
          collapsed: config.maxTranslate,
        };
      }

      function getClosestState(translate, snapPoints) {
        let closest = "expanded";
        let min = Math.abs(translate - snapPoints.expanded);
        ["default", "collapsed"].forEach((state) => {
          const distance = Math.abs(translate - snapPoints[state]);
          if (distance < min) {
            min = distance;
            closest = state;
          }
        });
        return closest;
      }

      function getNextState(state, direction) {
        const order = ["expanded", "default", "collapsed"];
        let index = order.indexOf(state);
        if (index === -1) index = 1;
        index += direction === "down" ? 1 : -1;
        index = Math.max(0, Math.min(order.length - 1, index));
        return order[index];
      }

      function applyResistance(value, min, max, resistance) {
        if (value < min) {
          return min - (min - value) * resistance;
        }
        if (value > max) {
          return max + (value - max) * resistance;
        }
        return value;
      }

      function updateDragVelocity(newTranslate) {
        const now = performance.now();
        const dt = now - lastMoveTime;
        if (dt > 0) {
          dragVelocity = (newTranslate - lastMoveTranslate) / dt;
        }
        lastMoveTime = now;
        lastMoveTranslate = newTranslate;
      }

      function getDragDirection(delta, velocity) {
        const intent = 12;
        const velocityThreshold = 0.35;
        if (delta < -intent || velocity < -velocityThreshold) return "up";
        if (delta > intent || velocity > velocityThreshold) return "down";
        return null;
      }

      function setButtonStatus(btn, label) {
        if (!btn) return;
        if (!btn.dataset.originalHtml) {
          btn.dataset.originalHtml = btn.innerHTML;
        }
        btn.innerHTML = `${checkIcon}<span>${label}</span>`;
        if (statusTimers.has(btn)) {
          clearTimeout(statusTimers.get(btn));
        }
        const timer = setTimeout(() => {
          if (btn.dataset.originalHtml) {
            btn.innerHTML = btn.dataset.originalHtml;
          }
        }, 2000);
        statusTimers.set(btn, timer);
      }

      function isMobile() {
        return window.innerWidth <= 768;
      }

      function initMobileSheet() {
        const sidebar = document.getElementById("sidebar");
        const dragHandle = document.getElementById("dragHandle");

        if (!dragHandle || !sidebar) return;

        dragHandle.addEventListener("touchstart", handleTouchStart, {
          passive: false,
        });
        dragHandle.addEventListener("touchmove", handleTouchMove, {
          passive: false,
        });
        dragHandle.addEventListener("touchend", handleTouchEnd);
        dragHandle.addEventListener("touchcancel", handleTouchEnd);
        document.addEventListener("touchend", handleTouchEnd);
        document.addEventListener("touchcancel", handleTouchEnd);

        // Allow mouse dragging on the handle area
        dragHandle.addEventListener("mousedown", handleMouseDown);
        document.addEventListener("mousemove", handleMouseMove);
        document.addEventListener("mouseup", handleMouseUp);

        // Tap on canvas to collapse
        document
          .querySelector(".canvas-area")
          .addEventListener("click", (e) => {
            if (
              isMobile() &&
              sheetState !== "collapsed" &&
              !e.target.closest(".mobile-fab")
            ) {
              setSheetState("collapsed");
            }
          });

        // Update sheet state on resize
        window.addEventListener("resize", () => {
          if (!isMobile()) {
            sidebar.style.transform = "";
            sidebar.classList.remove("collapsed", "expanded", "dragging");
            dragHandle.classList.remove("dragging");
          }
        });
      }

      function handleTouchStart(e) {
        if (!isMobile()) return;
        e.preventDefault();
        dragConfig = getSheetConfig();
        dragSnapPoints = getSnapPoints(dragConfig);
        isDragging = true;
        startY = e.touches[0].clientY;
        startTranslate = getCurrentTranslate();
        currentTranslate = startTranslate;
        dragStartState = getClosestState(startTranslate, dragSnapPoints);
        dragVelocity = 0;
        lastMoveTime = performance.now();
        lastMoveTranslate = startTranslate;
        setDragActive(true);
      }

      function handleTouchMove(e) {
        if (!isDragging || !isMobile()) return;
        e.preventDefault();
        const deltaY = e.touches[0].clientY - startY;
        const sidebar = document.getElementById("sidebar");
        if (!dragConfig) {
          dragConfig = getSheetConfig();
          dragSnapPoints = getSnapPoints(dragConfig);
        }

        // Calculate new translate (positive = more hidden)
        const rawTranslate = startTranslate + deltaY;
        currentTranslate = applyResistance(
          rawTranslate,
          0,
          dragConfig.maxTranslate,
          dragConfig.resistance
        );
        sidebar.style.transform = `translate3d(0, ${currentTranslate}px, 0)`;
        updateDragVelocity(currentTranslate);
      }

      function handleTouchEnd() {
        if (!isMobile()) return;
        if (!isDragging) {
          const dragHandle = document.getElementById("dragHandle");
          if (dragHandle && dragHandle.classList.contains("dragging")) {
            setDragActive(false);
            forceHandleRepaint();
          }
          return;
        }
        isDragging = false;
        setDragActive(false);
        if (!dragConfig) {
          dragConfig = getSheetConfig();
          dragSnapPoints = getSnapPoints(dragConfig);
        }

        const totalDelta = currentTranslate - startTranslate;
        const direction = getDragDirection(totalDelta, dragVelocity);
        let targetState = getClosestState(currentTranslate, dragSnapPoints);

        if (direction) {
          const nextState = getNextState(dragStartState, direction);
          const distanceToNext = Math.abs(
            dragSnapPoints[nextState] - startTranslate
          );
          const travel = Math.abs(totalDelta);
          const allowSkip = travel > distanceToNext * 1.35;
          targetState = allowSkip
            ? getClosestState(currentTranslate, dragSnapPoints)
            : nextState;
        }

        setSheetState(targetState);
        forceHandleRepaint();
        dragConfig = null;
        dragSnapPoints = null;
      }

      function handleMouseDown(e) {
        if (!isMobile()) return;
        e.preventDefault();
        dragConfig = getSheetConfig();
        dragSnapPoints = getSnapPoints(dragConfig);
        isDragging = true;
        startY = e.clientY;
        startTranslate = getCurrentTranslate();
        currentTranslate = startTranslate;
        dragStartState = getClosestState(startTranslate, dragSnapPoints);
        dragVelocity = 0;
        lastMoveTime = performance.now();
        lastMoveTranslate = startTranslate;
        setDragActive(true);
      }

      function handleMouseMove(e) {
        if (!isDragging || !isMobile()) return;
        e.preventDefault();
        const deltaY = e.clientY - startY;
        const sidebar = document.getElementById("sidebar");
        if (!dragConfig) {
          dragConfig = getSheetConfig();
          dragSnapPoints = getSnapPoints(dragConfig);
        }

        const rawTranslate = startTranslate + deltaY;
        currentTranslate = applyResistance(
          rawTranslate,
          0,
          dragConfig.maxTranslate,
          dragConfig.resistance
        );
        sidebar.style.transform = `translate3d(0, ${currentTranslate}px, 0)`;
        updateDragVelocity(currentTranslate);
      }

      function handleMouseUp() {
        if (!isDragging || !isMobile()) return;
        handleTouchEnd();
      }

      function getCurrentTranslate() {
        const sidebar = document.getElementById("sidebar");
        const style = window.getComputedStyle(sidebar);
        if (!style.transform || style.transform === "none") {
          return 0;
        }
        const matrix = new DOMMatrix(style.transform);
        return matrix.m42;
      }

      function setSheetState(state) {
        const sidebar = document.getElementById("sidebar");
        sheetState = state;

        sidebar.classList.remove("collapsed", "expanded");
        sidebar.style.transform = "";

        if (state === "collapsed") {
          sidebar.classList.add("collapsed");
        } else if (state === "expanded") {
          sidebar.classList.add("expanded");
        }
      }

      function init() {
        const container = document.getElementById("presets");
        presets.forEach((p) => {
          const btn = document.createElement("button");
          btn.className = "preset";
          btn.innerHTML = miniSVG(p.a, p.b, p.p);
          btn.onclick = () => {
            document.getElementById("freqA").value = p.a;
            document.getElementById("freqB").value = p.b;
            document.getElementById("phase").value = p.p;
            update();
          };
          container.appendChild(btn);
        });

        document.querySelectorAll(".tab").forEach((tab) => {
          tab.onclick = () => {
            document
              .querySelectorAll(".tab")
              .forEach((t) => t.classList.remove("active"));
            document
              .querySelectorAll(".tab-panel")
              .forEach((p) => p.classList.remove("active"));
            tab.classList.add("active");
            document
              .getElementById("panel-" + tab.dataset.tab)
              .classList.add("active");

            // On mobile, expand when changing tabs
            if (isMobile() && sheetState === "collapsed") {
              setSheetState("default");
            }
          };
        });

        document.querySelectorAll(".modal-tab").forEach((tab) => {
          tab.onclick = () => {
            document
              .querySelectorAll(".modal-tab")
              .forEach((t) => t.classList.remove("active"));
            document
              .querySelectorAll(".modal-panel")
              .forEach((p) => p.classList.remove("active"));
            tab.classList.add("active");
            document
              .getElementById("modal-panel-" + tab.dataset.modalTab)
              .classList.add("active");
            const modalBody = document.querySelector(".modal-body");
            if (modalBody) {
              modalBody.scrollTop = 0;
            }
          };
        });

        document.querySelectorAll("input, select").forEach((el) => {
          el.addEventListener("input", update);
        });

        syncColors("strokeColor", "strokeHex");
        syncColors("strokeColor2", "strokeHex2");
        syncColors("fillColor", "fillHex");
        syncColors("bgColor", "bgHex");

        document
          .getElementById("canvasWidth")
          .addEventListener("input", (e) => {
            if (linkedDims)
              document.getElementById("canvasHeight").value = e.target.value;
            update();
          });

        document
          .getElementById("exportModal")
          .addEventListener("click", (e) => {
            if (e.target.id === "exportModal") closeExportModal();
          });

        document.addEventListener("keydown", handleGlobalKeydown);

        // Initialize mobile bottom sheet
        initMobileSheet();

        // Initialize accent color
        updateAccentColor("#6366f1");
        setPNGScale(pngScale);
        update();
      }

      function miniSVG(a, b, p) {
        let d = "M";
        const pr = (p * Math.PI) / 180;
        for (let t = 0; t <= Math.PI * 2; t += 0.1) {
          const x = 20 + 16 * Math.sin(a * t + pr);
          const y = 20 + 16 * Math.sin(b * t);
          d += `${x.toFixed(1)},${y.toFixed(1)} `;
        }
        return `<svg viewBox="0 0 40 40"><path d="${d}Z" fill="none" stroke="var(--accent)" stroke-width="1.5"/></svg>`;
      }

      function hexToHSL(hex) {
        const r = parseInt(hex.slice(1, 3), 16) / 255;
        const g = parseInt(hex.slice(3, 5), 16) / 255;
        const b = parseInt(hex.slice(5, 7), 16) / 255;

        const max = Math.max(r, g, b),
          min = Math.min(r, g, b);
        let h = 0,
          s = 0,
          l = (max + min) / 2;

        if (max !== min) {
          const d = max - min;
          s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
          switch (max) {
            case r:
              h = ((g - b) / d + (g < b ? 6 : 0)) / 6;
              break;
            case g:
              h = ((b - r) / d + 2) / 6;
              break;
            case b:
              h = ((r - g) / d + 4) / 6;
              break;
          }
        }
        return { h: h * 360, s: s * 100, l: l * 100 };
      }

      function hslToHex(h, s, l) {
        s /= 100;
        l /= 100;
        const a = s * Math.min(l, 1 - l);
        const f = (n) => {
          const k = (n + h / 30) % 12;
          const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
          return Math.round(255 * color)
            .toString(16)
            .padStart(2, "0");
        };
        return `#${f(0)}${f(8)}${f(4)}`;
      }

      function updateAccentColor(hex) {
        const hsl = hexToHSL(hex);
        currentHue = hsl.h;

        const root = document.documentElement;
        const isDark = root.getAttribute("data-theme") !== "light";
        const rootStyles = getComputedStyle(root);
        const baseLightness = parseFloat(
          rootStyles.getPropertyValue("--accent-base-l")
        );
        const targetLightness = Number.isFinite(baseLightness)
          ? baseLightness
          : isDark
          ? 68
          : 45;
        const adjustedLightness = isDark
          ? Math.max(hsl.l, targetLightness)
          : Math.min(hsl.l, targetLightness);

        const accentHex = hslToHex(hsl.h, hsl.s, adjustedLightness);
        const hoverLightness = Math.max(
          0,
          Math.min(100, adjustedLightness + (isDark ? 8 : -8))
        );
        const hoverHex = hslToHex(hsl.h, hsl.s, hoverLightness);

        const r = parseInt(accentHex.slice(1, 3), 16);
        const g = parseInt(accentHex.slice(3, 5), 16);
        const b = parseInt(accentHex.slice(5, 7), 16);

        document.documentElement.style.setProperty("--accent", accentHex);
        document.documentElement.style.setProperty(
          "--accent-rgb",
          `${r}, ${g}, ${b}`
        );
        document.documentElement.style.setProperty(
          "--accent-soft",
          `rgba(${r}, ${g}, ${b}, 0.15)`
        );
        document.documentElement.style.setProperty("--accent-hover", hoverHex);

        document.querySelectorAll(".preset").forEach((btn, i) => {
          btn.innerHTML = miniSVG(presets[i].a, presets[i].b, presets[i].p);
        });
      }

      function syncColors(colorId, hexId) {
        const c = document.getElementById(colorId);
        const h = document.getElementById(hexId);
        c.addEventListener("input", () => {
          h.value = c.value;
          if (colorId === "strokeColor") updateAccentColor(c.value);
          update();
        });
        h.addEventListener("input", () => {
          if (/^#[0-9a-fA-F]{6}$/.test(h.value)) {
            c.value = h.value;
            if (colorId === "strokeColor") updateAccentColor(h.value);
            update();
          }
        });
      }

      function adjustNum(id, delta) {
        const el = document.getElementById(id);
        el.value = Math.max(1, Math.min(20, parseInt(el.value) + delta));
        update();
      }

      function toggle(el) {
        el.classList.toggle("active");
        if (el.id === "gradientToggle") {
          document.getElementById("gradientRow").style.display =
            el.classList.contains("active") ? "flex" : "none";
        }
        if (el.id === "fillToggle") {
          document.getElementById("fillOptions").style.display =
            el.classList.contains("active") ? "block" : "none";
        }
        if (el.id === "bgFillToggle") {
          document.getElementById("bgColorRow").style.display =
            el.classList.contains("active") ? "block" : "none";
        }
        update();
      }

      function toggleLink() {
        linkedDims = !linkedDims;
        document
          .getElementById("linkBtn")
          .classList.toggle("active", linkedDims);
      }

      function setSize(s) {
        document.getElementById("canvasWidth").value = s;
        document.getElementById("canvasHeight").value = s;
        update();
      }

      function toggleTheme() {
        const html = document.documentElement;
        const current = html.getAttribute("data-theme");
        html.setAttribute("data-theme", current === "dark" ? "light" : "dark");
        updateAccentColor(document.getElementById("strokeColor").value);
      }

      function generatePath(
        phaseOverride = null,
        wOverride = null,
        hOverride = null
      ) {
        const w =
          wOverride || parseInt(document.getElementById("canvasWidth").value);
        const h =
          hOverride || parseInt(document.getElementById("canvasHeight").value);
        const freqA = parseInt(document.getElementById("freqA").value);
        const freqB = parseInt(document.getElementById("freqB").value);
        const phase =
          phaseOverride !== null
            ? phaseOverride
            : isAnimating
            ? animPhase
            : parseFloat(document.getElementById("phase").value);
        const phaseRad = (phase * Math.PI) / 180;
        const rotation =
          (parseFloat(document.getElementById("rotation").value) * Math.PI) /
          180;
        const scale = parseFloat(document.getElementById("scale").value) / 100;
        const res = parseInt(document.getElementById("resolution").value);
        const strokeW = parseFloat(
          document.getElementById("strokeWidth").value
        );

        const cx = w / 2,
          cy = h / 2;
        const maxRadius = Math.min(w, h) / 2 - strokeW - 2;
        const amp = maxRadius * scale;

        let d = "M";
        for (let i = 0; i <= res; i++) {
          const t = (i / res) * Math.PI * 2;
          let x = amp * Math.sin(freqA * t + phaseRad);
          let y = amp * Math.sin(freqB * t);
          const rx = x * Math.cos(rotation) - y * Math.sin(rotation);
          const ry = x * Math.sin(rotation) + y * Math.cos(rotation);
          d += `${(cx + rx).toFixed(2)},${(cy + ry).toFixed(2)} `;
        }
        return d + "Z";
      }

      function update() {
        const svg = document.getElementById("preview");
        const w = parseInt(document.getElementById("canvasWidth").value);
        const h = parseInt(document.getElementById("canvasHeight").value);

        svg.setAttribute("width", w);
        svg.setAttribute("height", h);
        svg.setAttribute("viewBox", `0 0 ${w} ${h}`);
        document.getElementById("canvas-info").textContent = `${w} × ${h}`;

        document.getElementById("png-1x").textContent = `${w}×${h}`;
        document.getElementById("png-2x").textContent = `${w * 2}×${h * 2}`;
        document.getElementById("png-4x").textContent = `${w * 4}×${h * 4}`;

        const phase = isAnimating
          ? animPhase
          : parseFloat(document.getElementById("phase").value);
        document.getElementById("phase-val").textContent =
          Math.round(phase) + "°";
        document.getElementById("rotation-val").textContent =
          document.getElementById("rotation").value + "°";
        document.getElementById("scale-val").textContent =
          document.getElementById("scale").value + "%";
        document.getElementById("resolution-val").textContent =
          document.getElementById("resolution").value;
        document.getElementById("strokeWidth-val").textContent =
          document.getElementById("strokeWidth").value;
        document.getElementById("strokeOpacity-val").textContent =
          document.getElementById("strokeOpacity").value + "%";
        document.getElementById("fillOpacity-val").textContent =
          document.getElementById("fillOpacity").value + "%";
        document.getElementById("speed-val").textContent =
          document.getElementById("animSpeed").value + "×";
        document.getElementById("ratio-display").textContent =
          document.getElementById("freqA").value +
          ":" +
          document.getElementById("freqB").value;

        const d = generatePath();

        const strokeColor = document.getElementById("strokeColor").value;
        const strokeColor2 = document.getElementById("strokeColor2").value;
        const useGradient = document
          .getElementById("gradientToggle")
          .classList.contains("active");
        const useFill = document
          .getElementById("fillToggle")
          .classList.contains("active");
        const useBgFill = document
          .getElementById("bgFillToggle")
          .classList.contains("active");

        let content = `<defs>
          <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="${strokeColor}"/>
            <stop offset="100%" stop-color="${strokeColor2}"/>
          </linearGradient>
        </defs>`;

        if (useBgFill) {
          content += `<rect width="100%" height="100%" fill="${
            document.getElementById("bgColor").value
          }"/>`;
        }

        const dash = document.getElementById("dashPattern").value;
        content += `<path d="${d}"
          fill="${
            useFill ? document.getElementById("fillColor").value : "none"
          }"
          fill-opacity="${
            useFill ? document.getElementById("fillOpacity").value / 100 : 0
          }"
          stroke="${useGradient ? "url(#grad)" : strokeColor}"
          stroke-width="${document.getElementById("strokeWidth").value}"
          stroke-opacity="${
            document.getElementById("strokeOpacity").value / 100
          }"
          stroke-linecap="${document.getElementById("lineCap").value}"
          stroke-linejoin="${document.getElementById("lineJoin").value}"
          ${dash ? `stroke-dasharray="${dash}"` : ""}
        />`;

        svg.innerHTML = content;
      }

      function isEditableTarget(target) {
        if (!target) return false;
        if (target.isContentEditable) return true;
        const tag = target.tagName;
        if (!tag) return false;
        return ["INPUT", "TEXTAREA", "SELECT", "BUTTON"].includes(tag);
      }

      function handleGlobalKeydown(e) {
        if (e.key === "Escape") {
          const modal = document.getElementById("exportModal");
          if (modal.classList.contains("show")) {
            e.preventDefault();
            closeExportModal();
          }
          return;
        }

        if (isEditableTarget(e.target)) return;
        if (e.repeat) return;
        if (e.code === "Space" || e.key === " ") {
          e.preventDefault();
          toggleAnim();
        }
      }

      function updatePlayButtons() {
        const playIcon =
          '<svg viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21"/></svg>';
        const pauseIcon =
          '<svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>';

        const mainBtn = document.getElementById("playBtn");
        const mobileFab = document.getElementById("mobileFabPlay");
        const quickBar = document.getElementById("quickBarPlay");

        if (isAnimating) {
          mainBtn.innerHTML = `${pauseIcon}<span id="playBtnText">Pause</span>`;
          if (mobileFab) mobileFab.innerHTML = pauseIcon;
          if (quickBar) quickBar.innerHTML = `${pauseIcon} Pause`;
        } else {
          mainBtn.innerHTML = `${playIcon}<span id="playBtnText">Play Animation</span>`;
          if (mobileFab) mobileFab.innerHTML = playIcon;
          if (quickBar) quickBar.innerHTML = `${playIcon} Play`;
        }
      }

      function toggleAnim() {
        isAnimating = !isAnimating;
        updatePlayButtons();

        if (isAnimating) {
          animPhase = parseFloat(document.getElementById("phase").value);
          animate();
        } else {
          cancelAnimationFrame(animId);
          document.getElementById("phase").value = Math.round(animPhase) % 360;
        }
      }

      function animate() {
        if (!isAnimating) return;
        animPhase =
          (animPhase + parseFloat(document.getElementById("animSpeed").value)) %
          360;
        update();
        animId = requestAnimationFrame(animate);
      }

      function randomize() {
        document.getElementById("freqA").value =
          Math.floor(Math.random() * 10) + 1;
        document.getElementById("freqB").value =
          Math.floor(Math.random() * 10) + 1;
        document.getElementById("phase").value = Math.floor(
          Math.random() * 360
        );
        document.getElementById("scale").value =
          Math.floor(Math.random() * 60) + 40;
        const newColor =
          "#" +
          Math.floor(Math.random() * 16777215)
            .toString(16)
            .padStart(6, "0");
        document.getElementById("strokeColor").value = newColor;
        document.getElementById("strokeHex").value = newColor;
        updateAccentColor(newColor);
        document.getElementById("strokeColor2").value =
          "#" +
          Math.floor(Math.random() * 16777215)
            .toString(16)
            .padStart(6, "0");
        document.getElementById("strokeHex2").value =
          document.getElementById("strokeColor2").value;
        document.getElementById("strokeWidth").value = (
          Math.random() * 4 +
          1
        ).toFixed(1);
        update();
      }

      function resetAll() {
        document.getElementById("freqA").value = 3;
        document.getElementById("freqB").value = 4;
        document.getElementById("phase").value = 0;
        document.getElementById("rotation").value = 0;
        document.getElementById("scale").value = 85;
        document.getElementById("resolution").value = 500;
        document.getElementById("strokeColor").value = "#6366f1";
        document.getElementById("strokeHex").value = "#6366f1";
        updateAccentColor("#6366f1");
        document.getElementById("strokeColor2").value = "#ec4899";
        document.getElementById("strokeHex2").value = "#ec4899";
        document.getElementById("strokeWidth").value = 2;
        document.getElementById("strokeOpacity").value = 100;
        document.getElementById("lineCap").value = "round";
        document.getElementById("lineJoin").value = "round";
        document.getElementById("dashPattern").value = "";
        document.getElementById("fillColor").value = "#6366f1";
        document.getElementById("fillHex").value = "#6366f1";
        document.getElementById("fillOpacity").value = 15;
        document.getElementById("canvasWidth").value = 400;
        document.getElementById("canvasHeight").value = 400;
        document.getElementById("bgColor").value = "#0a0a0f";
        document.getElementById("bgHex").value = "#0a0a0f";

        ["gradientToggle", "fillToggle", "bgFillToggle"].forEach((id) => {
          document.getElementById(id).classList.remove("active");
        });
        document.getElementById("gradientRow").style.display = "none";
        document.getElementById("fillOptions").style.display = "none";
        document.getElementById("bgColorRow").style.display = "none";

        update();
      }

      function getSVG() {
        const svg = document.getElementById("preview").cloneNode(true);
        svg.setAttribute("xmlns", "http://www.w3.org/2000/svg");
        return new XMLSerializer().serializeToString(svg);
      }

      function openExportModal() {
        document.getElementById("exportModal").classList.add("show");
      }

      function closeExportModal() {
        document.getElementById("exportModal").classList.remove("show");
      }

      function downloadSVG(btn) {
        const blob = new Blob([getSVG()], { type: "image/svg+xml" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "lissajous.svg";
        a.click();
        setButtonStatus(btn, "Downloaded");
      }

      async function copyTextToClipboard(text) {
        if (
          navigator.clipboard &&
          navigator.clipboard.writeText &&
          window.isSecureContext
        ) {
          try {
            await navigator.clipboard.writeText(text);
            return true;
          } catch (err) {
            // Fall through to the legacy copy path.
          }
        }
        const textarea = document.createElement("textarea");
        textarea.value = text;
        textarea.setAttribute("readonly", "");
        textarea.style.position = "fixed";
        textarea.style.top = "-1000px";
        textarea.style.left = "0";
        textarea.style.opacity = "0";
        document.body.appendChild(textarea);
        textarea.focus();
        textarea.select();
        textarea.setSelectionRange(0, textarea.value.length);
        let copied = false;
        try {
          copied = document.execCommand("copy");
        } catch (err) {
          copied = false;
        }
        document.body.removeChild(textarea);
        return copied;
      }

      async function copySVG(btn) {
        const copied = await copyTextToClipboard(getSVG());
        setButtonStatus(btn, copied ? "Copied" : "Copy failed");
      }

      async function quickCopySVG(btn) {
        const copied = await copyTextToClipboard(getSVG());
        setButtonStatus(btn, copied ? "Copied" : "Copy failed");
      }

      function setPNGScale(scale) {
        const nextScale = parseInt(scale, 10);
        pngScale = Number.isNaN(nextScale) ? 1 : nextScale;
        document.querySelectorAll(".png-size-btn").forEach((btn) => {
          const btnScale = parseInt(btn.dataset.scale, 10);
          btn.classList.toggle("active", btnScale === pngScale);
        });
      }

      function renderPNGCanvas(scale) {
        return new Promise((resolve, reject) => {
          const svg = document.getElementById("preview");
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          const w = parseInt(svg.getAttribute("width"));
          const h = parseInt(svg.getAttribute("height"));
          canvas.width = w * scale;
          canvas.height = h * scale;
          ctx.scale(scale, scale);

          const img = new Image();
          img.onload = () => {
            ctx.drawImage(img, 0, 0, w, h);
            resolve(canvas);
          };
          img.onerror = () => reject(new Error("PNG render failed"));
          img.src =
            "data:image/svg+xml;base64," +
            btoa(unescape(encodeURIComponent(getSVG())));
        });
      }

      async function downloadPNG(btn) {
        const safeScale = Math.max(1, parseInt(pngScale, 10) || 1);
        try {
          const canvas = await renderPNGCanvas(safeScale);
          const blob = await new Promise((resolve) =>
            canvas.toBlob(resolve, "image/png")
          );
          if (!blob) return;
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `lissajous-${safeScale}x.png`;
          a.click();
          URL.revokeObjectURL(url);
        } catch (err) {
          return;
        }
        setButtonStatus(btn, "Downloaded");
      }

      async function copyPNG(btn) {
        if (!navigator.clipboard || !window.ClipboardItem) {
          setButtonStatus(btn, "Copy unsupported");
          return;
        }
        const safeScale = Math.max(1, parseInt(pngScale, 10) || 1);
        try {
          const canvas = await renderPNGCanvas(safeScale);
          const blob = await new Promise((resolve) =>
            canvas.toBlob(resolve, "image/png")
          );
          if (!blob) {
            setButtonStatus(btn, "Copy failed");
            return;
          }
          await navigator.clipboard.write([
            new ClipboardItem({ "image/png": blob }),
          ]);
        } catch (err) {
          setButtonStatus(btn, "Copy failed");
          return;
        }
        setButtonStatus(btn, "Copied");
      }

      function renderFrameToCanvas(ctx, phase, size) {
        const w = size,
          h = size;
        const freqA = parseInt(document.getElementById("freqA").value);
        const freqB = parseInt(document.getElementById("freqB").value);
        const phaseRad = (phase * Math.PI) / 180;
        const rotation =
          (parseFloat(document.getElementById("rotation").value) * Math.PI) /
          180;
        const scale = parseFloat(document.getElementById("scale").value) / 100;
        const res = parseInt(document.getElementById("resolution").value);
        const strokeW =
          parseFloat(document.getElementById("strokeWidth").value) *
          (size / 400);

        const cx = w / 2,
          cy = h / 2;
        const maxRadius = w / 2 - strokeW - 2;
        const amp = maxRadius * scale;

        const useBgFill = document
          .getElementById("bgFillToggle")
          .classList.contains("active");
        if (useBgFill) {
          ctx.fillStyle = document.getElementById("bgColor").value;
          ctx.fillRect(0, 0, w, h);
        } else {
          ctx.clearRect(0, 0, w, h);
        }

        ctx.beginPath();
        for (let i = 0; i <= res; i++) {
          const t = (i / res) * Math.PI * 2;
          let x = amp * Math.sin(freqA * t + phaseRad);
          let y = amp * Math.sin(freqB * t);
          const rx = x * Math.cos(rotation) - y * Math.sin(rotation);
          const ry = x * Math.sin(rotation) + y * Math.cos(rotation);
          if (i === 0) ctx.moveTo(cx + rx, cy + ry);
          else ctx.lineTo(cx + rx, cy + ry);
        }
        ctx.closePath();

        const useFill = document
          .getElementById("fillToggle")
          .classList.contains("active");
        if (useFill) {
          ctx.fillStyle = document.getElementById("fillColor").value;
          ctx.globalAlpha = document.getElementById("fillOpacity").value / 100;
          ctx.fill();
          ctx.globalAlpha = 1;
        }

        const useGradient = document
          .getElementById("gradientToggle")
          .classList.contains("active");
        if (useGradient) {
          const grad = ctx.createLinearGradient(0, 0, w, h);
          grad.addColorStop(0, document.getElementById("strokeColor").value);
          grad.addColorStop(1, document.getElementById("strokeColor2").value);
          ctx.strokeStyle = grad;
        } else {
          ctx.strokeStyle = document.getElementById("strokeColor").value;
        }

        ctx.lineWidth = strokeW;
        ctx.lineCap = document.getElementById("lineCap").value;
        ctx.lineJoin = document.getElementById("lineJoin").value;
        ctx.globalAlpha = document.getElementById("strokeOpacity").value / 100;

        const dash = document.getElementById("dashPattern").value;
        if (dash) {
          ctx.setLineDash(dash.split(",").map(Number));
        } else {
          ctx.setLineDash([]);
        }

        ctx.stroke();
        ctx.globalAlpha = 1;
      }

      async function exportGIF() {
        const btn = document.getElementById("gifBtn");
        const progress = document.getElementById("gifProgress");
        const progressFill = document.getElementById("gifProgressFill");
        const progressText = document.getElementById("gifProgressText");

        btn.disabled = true;
        progress.classList.add("show");

        const duration = Math.max(
          0.5,
          parseFloat(document.getElementById("gifDuration").value) || 2
        );
        const fps = parseInt(document.getElementById("gifFps").value);
        const size = Math.max(
          100,
          Math.round(
            parseFloat(document.getElementById("gifSize").value) || 400
          )
        );
        const totalFrames = Math.max(1, Math.round(duration * fps));

        const canvas = document.getElementById("renderCanvas");
        canvas.width = size;
        canvas.height = size;
        const ctx = canvas.getContext("2d");

        const encoder = new GIFEncoder(size, size);
        encoder.setDelay(1000 / fps);

        const startPhase = parseFloat(document.getElementById("phase").value);

        for (let i = 0; i < totalFrames; i++) {
          const phase = (startPhase + (i / totalFrames) * 360) % 360;
          renderFrameToCanvas(ctx, phase, size);
          encoder.addFrame(ctx);

          const pct = ((i + 1) / totalFrames) * 100;
          progressFill.style.width = pct + "%";
          progressText.textContent = `Rendering frame ${
            i + 1
          }/${totalFrames}...`;

          await new Promise((r) => setTimeout(r, 0));
        }

        progressText.textContent = "Encoding GIF...";
        await new Promise((r) => setTimeout(r, 50));

        const gifData = encoder.finish();
        const blob = new Blob([gifData], { type: "image/gif" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "lissajous.gif";
        a.click();

        URL.revokeObjectURL(url);
        btn.disabled = false;
        progress.classList.remove("show");
        progressFill.style.width = "0%";
        setButtonStatus(btn, "Downloaded");
      }

      async function exportWebM() {
        const btn = document.getElementById("webmBtn");
        const progress = document.getElementById("webmProgress");
        const progressFill = document.getElementById("webmProgressFill");
        const progressText = document.getElementById("webmProgressText");

        btn.disabled = true;
        progress.classList.add("show");

        const durationSeconds =
          parseFloat(document.getElementById("webmDuration").value) || 2;
        const duration = Math.max(0.5, durationSeconds) * 1000;
        const size = Math.max(
          200,
          Math.round(
            parseFloat(document.getElementById("webmSize").value) || 600
          )
        );

        const canvas = document.getElementById("renderCanvas");
        canvas.width = size;
        canvas.height = size;
        const ctx = canvas.getContext("2d");

        const stream = canvas.captureStream(30);
        const recorder = new MediaRecorder(stream, { mimeType: "video/webm" });
        const chunks = [];

        recorder.ondataavailable = (e) => chunks.push(e.data);
        recorder.onstop = () => {
          const blob = new Blob(chunks, { type: "video/webm" });
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = "lissajous.webm";
          a.click();

          btn.disabled = false;
          progress.classList.remove("show");
          progressFill.style.width = "0%";
          setButtonStatus(btn, "Downloaded");
        };

        recorder.start();
        const startTime = performance.now();
        const startPhase = parseFloat(document.getElementById("phase").value);

        function recordFrame() {
          const elapsed = performance.now() - startTime;
          const t = elapsed / duration;

          if (t >= 1) {
            recorder.stop();
            return;
          }

          const phase = (startPhase + t * 360) % 360;
          renderFrameToCanvas(ctx, phase, size);

          progressFill.style.width = t * 100 + "%";
          progressText.textContent = `Recording... ${Math.round(t * 100)}%`;

          requestAnimationFrame(recordFrame);
        }

        recordFrame();
      }

      init();
    </script>
  </body>
</html>
